var aliaLauncher=function(I){"use strict";var on=Object.defineProperty;var an=(I,v,k)=>v in I?on(I,v,{enumerable:!0,configurable:!0,writable:!0,value:k}):I[v]=k;var S=(I,v,k)=>an(I,typeof v!="symbol"?v+"":v,k);function v(e,t){throw new Error(`Unhandled discriminated union member: ${JSON.stringify(e)}`)}const k="x-alia-jwt",Me="x-alia-shop",Ue="x-alia-shopify-customer-id",Fe="x-alia-preview-key",Be="ALIA_NO_EVAL",Ke={Africa:["AO","BF","BI","BJ","BW","CD","CF","CG","CI","CM","CV","DJ","DZ","EG","EH","ER","ET","GA","GH","GM","GN","GQ","GW","IO","KE","KM","LR","LS","LY","MA","MG","ML","MR","MU","MW","MZ","NA","NE","NG","RE","RW","SC","SD","SL","SN","SO","SS","ST","SZ","TD","TG","TN","TZ","UG","YT","ZA","ZM","ZW"],Antarctica:["AQ","BV","GS","HM","TF"],Asia:["AF","AE","AM","AZ","BD","BH","BN","BT","CN","CY","GE","HK","ID","IL","IN","IQ","IR","JP","JO","KH","KG","KP","KR","KW","KZ","LA","LB","LK","MN","MO","MM","MV","MY","NP","OM","PH","PK","PS","QA","RU","SA","SG","SY","TH","TJ","TL","TM","TR","TW","UZ","VN","YE"],Europe:["AD","AL","AT","AX","BA","BE","BG","BY","CH","CZ","DE","DK","EE","ES","FI","FO","FR","GB","GG","GI","GR","HR","HU","IE","IM","IS","IT","JE","LI","LT","LU","LV","MC","MD","ME","MK","MT","NL","NO","PL","PT","RO","RS","RU","SE","SI","SJ","SK","SM","TR","UA","VA","XK"],"North America":["AG","AI","AW","BB","BL","BM","BQ","BS","BZ","CA","CR","CU","CW","DM","DO","GD","GL","GP","GT","HN","HT","JM","KN","KY","LC","MF","MQ","MS","MX","NI","PA","PM","PR","SV","SX","TC","TT","US","VC","VG","VI"],Oceania:["AS","AU","CC","CK","CX","FJ","FM","GU","KI","MH","MP","NC","NF","NR","NU","NZ","PF","PG","PN","PW","SB","TK","TO","TV","UM","VU","WF","WS"],"South America":["AR","BO","BR","CL","CO","EC","FK","GF","GY","PE","PY","SR","UY","VE"]},Ge=["AT","BE","BG","HR","CH","CY","CZ","DK","EE","FI","FR","DE","GB","GR","HU","IE","IS","IT","LI","LV","LT","LU","MT","NO","NL","PL","PT","RO","SK","SI","ES","SE"],Ve="_allEUCountries";function $e(e){return e===Ve}function se(e){return e.flatMap(t=>$e(t)?Ge:[t])}function He(e){if(e.length===0)return[];const t=new Set;for(const n of e){const r=Ke[n];r&&r.forEach(s=>t.add(s))}return Array.from(t)}function We(e,t){return new RegExp("^"+e.replace(/([.?+^$[\]\\(){}|/-])/g,"\\$1").replace(/\*/g,".*")+"$").test(t)}const ie=e=>e==="local"?localStorage:sessionStorage;function L(e,t){try{const r=ie(e).getItem(t);if(!r||r==="undefined")return null;const s=JSON.parse(r);return s==="undefined"?null:s??null}catch(n){return console.error(`Error getting ${t} from ${e}Storage:`,n),null}}function G(e,t,n){try{ie(e).setItem(t,JSON.stringify(n))}catch(r){console.error(`Error setting ${t} in ${e}Storage:`,r)}}function b(e){return typeof e=="string"?e:e instanceof Error?e.message:typeof e=="object"&&e!==null&&"error"in e&&typeof e.error=="string"?e.error:"An unknown error occurred"}function J(e){try{return new URL(e)}catch{return}}async function N(e){return new Promise(t=>setTimeout(t,e))}async function oe(e,t){return Promise.race([N(e),t()])}const C=()=>document;function w(e){return window[e]}function M(e,t){window[e]=t}const ae="ALIA_DISABLE_ANALYTICS_TRACKING";function Ye(){M(ae,!0)}function Je(){return w(ae)}function je(){try{const e=w("ALIA_PROFILE_PROPERTIES");return e&&typeof e=="object"&&!Array.isArray(e)?Object.fromEntries(Object.entries(e).filter(([,t])=>t!=null).map(([t,n])=>[t,String(n)])):void 0}catch{return}}function Ze(e){const t=je();t&&(e={...t,...e}),M("ALIA_PROFILE_PROPERTIES",e)}function xe(e){const t=u(e)?e:[],n=new Map;function r(...a){var l;t.push(...a);for(const p of a)(l=n.get(p.type))==null||l.forEach(A=>A(p))}function s({type:a,callback:l,retroactive:p=!1}){const A=l,E=n.get(a)??[];return E.push(A),n.set(a,E),p&&t.filter(T=>T.type===a).forEach(A),()=>{n.set(a,E.filter(R=>R!==l))}}function i(a){r({type:"open",triggerID:a})}function o(){r({type:"close"})}return s({type:"disableAnalyticsTracking",callback:()=>Ye(),retroactive:!0}),s({type:"setProperties",callback:({properties:a})=>Ze(a),retroactive:!0}),{push:r,listen:s,open:i,close:o};function c(a){return typeof a=="object"&&a!==null&&"type"in a&&typeof a.type=="string"}function u(a){return Array.isArray(a)&&a.every(c)}}const Xe="alia:";function Qe(e){const t=Xe+e.type,n=new CustomEvent(t,{detail:e});C().dispatchEvent(n)}const j=e=>()=>e.substring(0);async function qe(e){return new Promise((t,n)=>{const r=C().createElement("script");r.src=e,r.async=!0,r.onload=()=>t(r),r.onerror=()=>n(new Error("Failed to load Alia script")),C().head.appendChild(r)})}class ze{constructor(){S(this,"debugExtensionEnabled",!1);S(this,"appName","launcher");window.postMessage({type:"alia:loaded"},"*"),window.addEventListener("message",t=>{t.data&&t.data.type==="alia:debug_extension_enabled"&&(this.debugExtensionEnabled=!0)})}log(...t){console.log(`[Alia ${this.appName}]`,...t)}debug(...t){this.debugExtensionEnabled&&console.log(`%c[Alia ${this.appName} debug]`,"color: cyan",...t)}error(...t){console.error(`[Alia ${this.appName}]`,...t)}}const y=new ze;function ue(e){try{e()}catch(t){y.error(t)}}const ce="alia_user";function le(e,t){return e.searchParams.set(ce,encodeURIComponent(t)),e}function et(e){const t=e.searchParams.get(ce);if(t)return decodeURIComponent(t)}function fe({onLinkClick:e,onHistoryChange:t}){C().addEventListener("click",s=>{if(s.target instanceof HTMLElement){const i=s.target.closest("a");i&&(e==null||e(i))}});const n=history.pushState;history.pushState=function(s,i,o){let c;try{c=t==null?void 0:t(o)}catch(u){y.debug("Error intercepting navigation",u)}return n.call(this,s,i,c??o)};const r=history.replaceState;history.replaceState=function(s,i,o){let c;try{c=t==null?void 0:t(o)}catch(u){y.debug("Error intercepting navigation",u)}return r.call(this,s,i,c??o)}}const de="alia-jwt";async function P({method:e,path:t,args:n,headers:r,keepAlive:s,allowNoJWT:i=!1}){var E;const o=e!=="GET"&&"body"in n,c=nt(),{key:u}=O(),a=(E=U())==null?void 0:E.customerID;if(!c&&!i)throw new Error("Unauthorized");const l=await fetch(A(t,"params"in n&&n.params,"query"in n&&n.query),{method:e,keepalive:s,headers:{...o?{"Content-Type":"application/json"}:{},[Me]:Y(),...c?{[k]:c}:{},...u?{[Fe]:u}:{},...a?{[Ue]:a}:{},...r},...o?{body:JSON.stringify("body"in n?n.body:void 0)}:{}});if(l.status===204)return;const p=await l.json();if(l.ok)return p;throw typeof p!="object"||p==null?new Error("An unknown error occurred"):"error"in p&&typeof p.error=="string"?new Error(p.error):new Error("An unknown error occurred");function A(R,T,F){const B=new URL(ee());for(const[K,_]of Object.entries(T))R=R.replace(`:${K}`,String(_));B.pathname=`/launcher${R}`;for(const[K,_]of Object.entries(F))_!=null&&B.searchParams.set(K,String(_));return B.toString()}}const tt=(()=>{const e={};return{setItem:(t,n)=>{e[t]=n},getItem:t=>e[t]}})();function ge(){const e=[sessionStorage,tt];return O().key||e.unshift(localStorage),e}function pe(e){for(const t of ge())try{t.setItem(de,e)}catch{}}function nt(){for(const e of ge())try{const t=e.getItem(de);if(t)return t}catch{}return null}function O(){const e="alia_preview_key",t=new URLSearchParams(window.location.search),n=t.get("alia_preview_key");n&&sessionStorage.setItem(e,n);const r=t.get("flow_id"),s=r?parseInt(r):void 0;return{key:sessionStorage.getItem(e),flowID:Number.isNaN(s)?void 0:s}}function Z(){return O().key?"session":"local"}function rt(){ue(()=>{const e=new URL(window.location.href),t=et(e);return t&&pe(t),null})}function st(e,t){ue(()=>{const n=[(t==null?void 0:t.primaryDomain)??"",...(t==null?void 0:t.otherDomains)??[]].filter(s=>!!s);if(n.length<=1)return;const r=n.map(s=>new URL(s)).filter(s=>s.hostname!==window.location.hostname);fe({onLinkClick:s=>{r.some(i=>i.hostname===s.hostname)&&(s.href=le(new URL(s.href),e).toString())},onHistoryChange:s=>{if(s)return le(new URL(s),e).toString()}})})}function x(e){return P({method:"POST",path:"/errors",args:{body:e},allowNoJWT:!0})}async function it(e){return await P({method:"POST",path:"/user-flows",args:{body:e}})}async function ot(e){return await P({method:"POST",path:"/user-flows/preview",args:{body:e}})}async function at(e){return await P({method:"POST",path:"/users",args:{query:e},allowNoJWT:!0})}async function ut(e){return await P({method:"POST",path:"/user-actions",args:{body:e}})}const X="alia-user-actions";function ct(e){const t=[...e],n=L(Z(),X)??[];for(const r of n)r.id&&t.some(s=>s.id===r.id)||t.push(r);return t}class lt{constructor(t){S(this,"mediator");S(this,"actionsBuffer",[]);S(this,"isBuffering",!1);this.mediator=t,window.addEventListener("pageshow",()=>{this.loadFromStorage()})}setActions(t){const n=this.mediator.update(r=>({...r,actions:t(r.actions)}));G(Z(),X,n.actions)}loadFromStorage(){const t=L(Z(),X);t&&this.setActions(()=>[...t])}addActions(...t){this.setActions(n=>[...n,...t])}updateByCreatedAt(t,n){this.setActions(r=>r.map(s=>s.createdAt===t&&s.type===n.type?n:s))}async createAction(t){try{const n=new Date().toISOString();this.addActions({...t,type:t.data.type,createdAt:n}),this.isBuffering?this.actionsBuffer.push({...t,createdAt:n}):await this.publishAction({...t,createdAt:n})}catch(n){x({message:`Failed to create ${t.data.type} user action`,data:{action:t,error:b(n)}})}}async publishAction(t){const n=await ut(t);this.updateByCreatedAt(t.createdAt,n)}bufferUserActions(t){this.isBuffering=!0,t&&setTimeout(()=>{this.flushUserActions()},t)}async flushUserActions(){this.isBuffering=!1;const t=[...this.actionsBuffer];this.actionsBuffer.length=0;for(const n of t)await this.publishAction(n)}}class ft{constructor(t){S(this,"state");S(this,"subscriptions",[]);S(this,"userActionsStore");this.state=t,this.userActionsStore=new lt(this)}update(t){return this.state={...this.state,...t(this.state)},this.subscriptions.forEach(n=>n(this.state)),this.state}subscribe(t){return this.subscriptions.push(t),()=>{this.subscriptions=this.subscriptions.filter(n=>n!==t)}}}let V;window.addEventListener("message",e=>{e.data&&e.data.type==="alia:user_overrides"&&(V=e.data.overrides)});function dt(){try{if(!V||typeof V!="object")return;const e=V,t=r=>r in e?e[r]:void 0,n=r=>typeof r=="string"?r:void 0;return{country:n(t("country")),market:n(t("market")),language:n(t("language")),ipCountry:n(t("ipCountry")),ipRegion:n(t("ipRegion")),ipCity:n(t("ipCity"))}}catch(e){y.error("Failed to get overrides",e);return}}function Q(e){return`alia-session${e?`-${e}`:""}`}function ye(e=null){return L("session",Q(e))??{start:Date.now(),isEngaged:!1}}class gt{constructor(t,n){S(this,"isNewSession");S(this,"flowID",null);S(this,"onEngaged",null);this.flowID=t??null,this.onEngaged=n??null,this.setupEngagedListeners(),L("session",Q(this.flowID))?this.isNewSession=!1:(this.isNewSession=!0,this.setValue({start:Date.now(),isEngaged:!1}))}getValue(){return ye(this.flowID)}setValue(t){G("session",Q(this.flowID),t)}setupEngagedListeners(){fe({onLinkClick:t=>{t.href&&t.hostname===window.location.hostname&&this.handleEngagedSession()},onHistoryChange:()=>{this.handleEngagedSession()}})}handleNewSession(){this.isNewSession}handleEngagedSession(){var n;const t=this.getValue();t.isEngaged||(this.setValue({...t,isEngaged:!0}),(n=this.onEngaged)==null||n.call(this))}}async function he(e){Je()||await P({method:"POST",path:"/events/v2",args:{body:e},keepAlive:!0})}const me="alia-session-record";function pt(){const e=L("session",me);if(e!==null)return e;const t=Math.random()<.5;return G("session",me,t),t}class we{constructor(t){S(this,"tracker");S(this,"flowID",null);S(this,"shouldRecord");this.flowID=t??null,this.shouldRecord=pt(),this.tracker=new gt(t,()=>{he({flowID:this.flowID,type:"engagedSession",shouldRecordV2:this.shouldRecord})})}handleNewSession(){this.tracker.isNewSession&&he({flowID:this.flowID,type:"session",shouldRecordV2:this.shouldRecord})}}const yt=Symbol("NO_EVAL");function ht(e,t=!1){try{return wt(e,t)}catch(n){return y.error("Error executing code",{code:e,error:b(n)}),null}}function mt(){return w(yt)===!0||w(Be)===!0}function wt(e,t=!1){return!t&&mt()?void 0:new Function(e)()}async function At(e){return await P({method:"GET",path:"/integrations/klaviyo-oauth/lists",args:{query:e}})}async function St(e){return await P({method:"GET",path:"/integrations/klaviyo-oauth/segments",args:{query:e}})}async function It(e){const t=await ve("klaviyo");return t==="skip"||e.type==="klaviyo.identified"?t:!t}async function vt(){try{const{klaviyo:t}=await e(),n=await oe(1e3,async()=>await(t==null?void 0:t.isIdentified()));return n===void 0?void 0:n===!0}catch{return}async function e(){try{if(!Array.from(C().scripts).find(s=>s.src.includes("klaviyo.js")))return{klaviyo:void 0};const n=()=>w("klaviyo");return n()?{klaviyo:n()}:await oe(1e3,async()=>await new Promise(s=>{const i=setInterval(()=>{n()&&(s({klaviyo:n()}),clearInterval(i))},100)}))??{klaviyo:void 0}}catch{return{klaviyo:void 0}}}}async function Et(e){if(!e.listID)return!0;const t=e.listID,n=await Ct();return(n==null?void 0:n.includes(t))??e.fallback?e.type==="klaviyo.inList":e.type==="klaviyo.notInList"}async function Dt(e){if(!e.segmentID)return!0;const t=e.segmentID,n=await Rt();return(n==null?void 0:n.includes(t))??e.fallback?e.type==="klaviyo.inSegment":e.type==="klaviyo.notInSegment"}let $;async function Ct(){try{if($)return await $;const e=Ae();return e?($=Promise.race([At({exchangeID:e}),N(2e3)]),await $):void 0}catch(e){y.error(e);return}}let H;async function Rt(){try{if(H)return await H;const e=Ae();return e?(H=Promise.race([St({exchangeID:e}),N(2e3)]),await H):void 0}catch(e){y.error(e);return}}function Ae(){const t=s(C().cookie).__kla_id;if(!t)return;const n=JSON.parse(atob(t));if(!n||typeof n!="object")return;const r=Object.hasOwn(n,"$exchange_id")?n.$exchange_id:void 0;if(typeof r!="string")return;return r;function s(i){const o=i.split(";"),c={};for(let u=0;u<o.length;u++){const l=o[u].trim().split("=");if(l.length>1){const p=l[0],A=decodeURIComponent(l.slice(1).join("="));c[p]=A}}return c}}async function Pt(e,t){var s,i,o,c;if(t.evaluated.includes(e.resource.id))return"skip";const n=e.resource.type==="targetingRule"?(i=(s=t.targetingRules)==null?void 0:s.rules.find(u=>u.id===e.resource.id))==null?void 0:i.config:(c=(o=t.segments.find(u=>u.id===e.resource.id))==null?void 0:o.targeting)==null?void 0:c.rule;if(!n)return"skip";const r=await z(n,{...t,evaluated:[...t.evaluated,e.resource.id]});return r!=="skip"?e.type==="inTargetingRule"?r:!r:e.resource.type==="segment"&&e.type==="notInTargetingRule"?!1:"skip"}async function Tt(e,t){return await Promise.race([ht(`return (async ({ campaignID, profile: { user, actions } }) => { ${e.code} 
 })(${JSON.stringify({campaignID:t.segmentID,profile:t})})`),N(1e3)])===!0}const Se={klaviyo:async()=>await vt(),smsbump:async()=>{var e,t;return(t=(e=w("smsbump"))==null?void 0:e.isIdentified)==null?void 0:t.call(e)},unveild:async()=>{var e,t;return(t=(e=w("unveild"))==null?void 0:e.checkIfUserIdentified)==null?void 0:t.call(e)},upstack:async()=>{var e,t;return await((t=(e=w("_upsShopifyClient"))==null?void 0:e.isKnown)==null?void 0:t.call(e))},tie:async()=>{if(!Array.isArray(w("dataLayer")))return!1;for(const e of w("dataLayer"))if(e&&e.rrid_response&&Array.isArray(e.rrid_response.results))for(const{columns:t,data:n}of e.rrid_response.results){if(!Array.isArray(t)||!Array.isArray(n))continue;const r=t.indexOf("party_source");if(r!==-1){for(const{row:s}of n)if(Array.isArray(s)&&s[r]===1)return!0}}return!1}},Ie="alia-cookie-results",W=L("session",Ie)??{};async function _t(e){const n=(await Promise.all(Object.keys(Se).filter(r=>!e.exclude.includes(r)).map(async r=>await ve(r)))).some(r=>r===!0);return e.type==="cookie.identified"?n:!n}async function ve(e){try{if(W[e]!==void 0)return W[e];const n=await t();return W[e]=n,G("session",Ie,W),n}catch{return"skip"}async function t(){const n=await Se[e]();return n===!0?!0:n===!1?!1:"skip"}}function q(e,t){switch(e.operator){case"eq":return t===e.value;case"neq":return t!==e.value;case"gt":return t>e.value;case"gte":return t>=e.value;case"lt":return t<e.value;case"lte":return t<=e.value}}function Ee(e,t){const n=e.value*s(e.unit),r=Date.now()-t.getTime();switch(e.operator){case"gt":return r>n;case"lt":return r<n}function s(i){let o=1e3;if(i==="seconds"||(o*=60,i==="minutes")||(o*=60,i==="hours")||(o*=24,i==="days"))return o;if(i==="weeks")return o*7;if(o*=30,i==="months"||(o*=12,i==="years"))return o;v(i)}}function kt(e,{user:t},n){const s=(e.type==="hasNotVisitedPage"||e.type==="hasVisitedPage")&&t.profile.history?t.profile.history.flat().map(u=>J(u)):[J(window.location.href)],o=(e.matchType==="exact"?e.values:e.matchType==="contains"?e.values.map(u=>`*${u}*`):v(e.matchType)).some(u=>s.some(a=>a&&c(e.pageType,a,u)));return e.type==="hasVisitedPage"||e.type==="isOnPage"?o:!o;function c(u,a,l){const p=u==="url"?a.toString():u==="path"?a.pathname+a.search+a.hash:v(u);return We(A(l),A(p));function A(E){return E.replace(/\/$/,"")}}}function Lt(e,{user:t}){var r;const n=(r=t.profile.history)==null?void 0:r.at(-1);return n?q(e.value,n.length):!1}function Nt(e,{user:t}){var n;return q(e.value,((n=t.profile.history)==null?void 0:n.length)??0)}async function Ot(){const e=w("Shopify");if(!e)return{};const t=new Promise(n=>{e==null||e.loadFeatures([{name:"consent-tracking-api",version:"0.1"}],n)});return await Promise.race([t,N(1e3)]),e.customerPrivacy?{marketingAllowed:e.customerPrivacy.marketingAllowed(),saleOfDataAllowed:e.customerPrivacy.saleOfDataAllowed(),analyticsProcessingAllowed:e.customerPrivacy.analyticsProcessingAllowed(),preferencesProcessingAllowed:e.customerPrivacy.preferencesProcessingAllowed()}:{}}function bt(e,t){return q(e.value,t.user.shopifyNumOrders??0)}function Mt(e,t){const n=t.user.country;if(n===null)return!0;const r=se(e.countries).includes(n);return e.type==="shopify.inCountries"?r:!r}function Ut(e,t){const n=t.user.market;return n===null?!0:e.type==="shopify.inMarkets"?e.markets.includes(n):!e.markets.includes(n)}function Ft(e,t){const n=t.user.language;return n===null?!0:e.type==="shopify.inLocales"?e.locales.includes(n):!e.locales.includes(n)}async function Bt(e){const{marketingAllowed:t,saleOfDataAllowed:n,analyticsProcessingAllowed:r,preferencesProcessingAllowed:s}=await Ot();return e.consentTypes.some(o=>{switch(o){case"marketing":return t;case"saleOfData":return n;case"analyticsProcessing":return r;case"preferencesProcessing":return s}})}function De(e,t){const n=t.history.flat();for(const r of n.reverse()){const s=J(r),i=s==null?void 0:s.searchParams.get(e);if(i)return i}return null}function Kt(e,t){const n=De("utm_source",t.user.profile),r=e.values.includes(n);return e.type==="traffic.utmSourceIsIn"?r:!r}function Gt(e,t){const n=De("utm_medium",t.user.profile),r=e.values.includes(n);return e.type==="traffic.utmMediumIsIn"?r:!r}function Vt(e,t){return Ee(e.value,new Date(t.user.createdAt))}function $t(e,t){const n=t.user.isMobile;return n===null?!0:e.device==="mobile"?n:!n}function Ht(e,t){const n=t.user.ipCountry;if(n===null)return"skip";const r=se(e.countries).includes(n);return e.type==="user.inCountries"?r:!r}function Wt(e,t){const n=t.user.ipCountry;if(n===null)return"skip";const s=He(e.continents).includes(n);return e.type==="user.inContinents"?s:!s}function Yt(e,t){const n=t.user.ipRegion;return n===null?"skip":e.type==="user.inRegions"?e.regions.includes(n):!e.regions.includes(n)}function Jt(e,t){const n=t.user.ipCity,r=t.user.ipRegion;if(n===null||r===null)return"skip";const s=e.cityRegions.some(i=>i.city===n&&i.region===r);return e.type==="user.inCityRegions"?s:!s}function jt(e,t){const n=t.actions.some(r=>{if(e.action.type==="popupClose"){if(!(r.data.type==="popupClose"||r.data.type==="popupStep"&&r.data.isFloatingButton))return!1}else if(r.data.type!==e.action.type)return!1;return e.thisSession==="exclude"&&new Date(r.createdAt).getTime()>t.sessionStart?!1:e.filters?Zt(r,e.filters):!0});return e.type==="user.hasDoneAction"?!!n:!n}function Zt(e,t){return t.every(s=>{switch(s.type){case"userAction.date":return n(s);case"userAction.inSegments":case"userAction.notInSegments":return r(s)}});function n(s){return Ee(s.value,new Date(e.createdAt))}function r(s){const i=s.segmentIDs.some(o=>e.segmentID===o);return s.type==="userAction.inSegments"?i:!i}}async function Ce(e,t){switch(e.type){case"inTargetingRule":case"notInTargetingRule":return Pt(e,t);case"customCode":return await Tt(e,t);case"klaviyo.identified":case"klaviyo.notIdentified":return await It(e);case"klaviyo.inList":case"klaviyo.notInList":return await Et(e);case"klaviyo.inSegment":case"klaviyo.notInSegment":return await Dt(e);case"isOnPage":case"isNotOnPage":case"hasVisitedPage":case"hasNotVisitedPage":return kt(e,t);case"pages.numPagesViewed":return Lt(e,t);case"pages.numSessions":return Nt(e,t);case"shopify.numOrders":return bt(e,t);case"shopify.inMarkets":case"shopify.notInMarkets":return Ut(e,t);case"shopify.inLocales":case"shopify.notInLocales":return Ft(e,t);case"shopify.inCountries":case"shopify.notInCountries":return Mt(e,t);case"user.inCityRegions":case"user.notInCityRegions":return Jt(e,t);case"shopify.customerPrivacyAllowed":return Bt(e);case"user.createdAt":return Vt(e,t);case"user.device":return $t(e,t);case"user.inCountries":case"user.notInCountries":return Ht(e,t);case"user.inContinents":case"user.notInContinents":return Wt(e,t);case"user.inRegions":case"user.notInRegions":return Yt(e,t);case"user.hasDoneAction":case"user.hasNotDoneAction":return jt(e,t);case"traffic.utmSourceIsIn":case"traffic.utmSourceIsNotIn":return Kt(e,t);case"traffic.utmMediumIsIn":case"traffic.utmMediumIsNotIn":return Gt(e,t);case"cookie.identified":case"cookie.notIdentified":return _t(e)}}async function z(e,t){switch(e.type){case"and":return xt(e,t);case"or":return Xt(e,t)}}async function xt(e,t){const n=await Promise.all(e.conds.map(r=>Ce(r,t)));return n.some(r=>r===!1)?!1:n.some(r=>r==="skip")?"skip":!0}async function Xt(e,t){const n=await Promise.all(e.conds.map(r=>Ce(r,t)));return n.some(r=>r===!0)?!0:n.some(r=>r==="skip")?"skip":!1}const Re=[];async function Qt({user:e,actions:t,targetingRules:n,segments:r,integrationUsers:s}){return(await Promise.all(r.map(async o=>{try{return await z(o.targeting.rule,{user:e,actions:t,integrationUsers:s,evaluated:[],targetingRules:n,segments:r,segmentID:o.id,sessionStart:ye().start})===!1?void 0:o.id}catch(c){if(y.error(c),Re.includes(o.id))return;x({message:`Error evaluating targeting rule: ${b(c)}`,data:{error:b(c)},bucket:"merchant_error"}),Re.push(o.id);return}}))).filter(o=>o!==void 0)}const Y=j("im8store.myshopify.com");y.log(Y());const U=()=>w("ALIA_SHOPIFY_EXTENSION_INFO"),ee=j("https://backend.alia-prod.com"),te=j("v3.4.35"),Pe=5,qt=1e3;C().readyState!=="loading"?ne():C().addEventListener("DOMContentLoaded",()=>{ne()},{once:!0});async function ne(e=Pe){const t="ALIA_HAS_INITIALIZED";if(w(t)){y.log("Alia already initialized");return}if(M(t,!0),n()){y.log("Disabled for bot",navigator.userAgent);return}try{await zt()}catch(r){if(e<=0){y.error(`Failed after ${Pe} tries`),x({message:"Init failed",data:{error:b(r)}});return}else y.error("Init failed, trying again...",r),await N(2e3),ne(e-1)}function n(){const r=navigator.userAgent;return["Googlebot","bingbot","facebookexternalhit","Storebot-Google","AmazonProductDiscovery","Petalbot","Pinterestbot","Applebot","Twitterbot","meta-externalads","AdsBot-Google"].some(s=>r.includes(s))}}async function zt(){var _e,ke,Le,Ne;const e=await tn();rt();const t=new we,n=dt(),{jwt:r,disabledReason:s,...i}=await at({path:window.location.pathname+location.search,url:window.location.href,is_mobile:window.innerWidth<1024,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,ip_address:e,user_agent:navigator.userAgent,country:(n==null?void 0:n.country)??((_e=U())==null?void 0:_e.country),market:(n==null?void 0:n.market)??((ke=U())==null?void 0:ke.market),language:(n==null?void 0:n.language)??((Le=U())==null?void 0:Le.language),release_tag:te(),new_session:t.tracker.isNewSession,ip_country:(n==null?void 0:n.ipCountry)??void 0,ip_region:(n==null?void 0:n.ipRegion)??void 0,ip_city:(n==null?void 0:n.ipCity)??void 0});if(pe(r),st(r,(Ne=i.merchant)==null?void 0:Ne.settings),s){y.debug("Disabled",s);return}t.handleNewSession();let o=!1,c=!1,u,a,l;const p=[],A=[],E=[],R=[];let T;F();async function F(){T&&clearTimeout(T),await B(),!O().flowID&&(T=setTimeout(F,qt))}async function B(){var be;const{flowID:f}=O(),h=new Set;f||((await Qt({...i,actions:(l==null?void 0:l.state.actions)??i.actions,user:(l==null?void 0:l.state.user)??i.user,segments:i.segments.filter(D=>!A.includes(D.id))})).forEach(D=>h.add(D)),p.forEach(D=>h.add(D)));const d=Array.from(h).filter(m=>!A.includes(m));o||(f?y.debug("Previewing popup",f):d.length||y.debug("No matching campaigns")),A.push(...d);const g=d.length||f,[Oe]=await Promise.all([f?K():en(d),g?nn():void 0]);o||(u=w("alia"),a=xe(u??[]),a.listen({type:"open",callback:({ignoreTargeting:m,campaignID:D})=>{const re=Number(D);m===!0&&!isNaN(re)&&i.segments.some(sn=>sn.id===re)&&(p.push(re),F())},retroactive:!0}),l=new ft({actions:ct(i.actions),modalFlowID:rn(Oe),user:i.user}));for(const m of Oe){if(!((be=m.userFlow)!=null&&be.flowID)||E.includes(m.userFlow.flowID))continue;E.push(m.userFlow.flowID),Qe({type:"campaignMatched",campaignID:m.userFlow.segmentID,campaignTitle:m.userFlow.segmentTitle??void 0,popupID:m.userFlow.flowID,popupTitle:m.userFlow.flowTitle??void 0});const D=C().createElement("div");D.style.position="fixed",C().body.appendChild(D),R.push(window.mountAliaCustomerApp({shop:Y(),jwt:r,useShadowDOM:m.settings.useShadowDOM,initialData:m,targetingArgs:i,evaluateTargetingRule:z,target:D,messages:a,mediator:l}))}o||(o=!0,Te(),M("alia",{unmount:()=>R.forEach(m=>m()),push:a.push,messages:a,open:a.open,close:a.close,mediator:l}))}async function K(){const{flowID:f,key:h}=O();return f?[await ot({previewKey:h??"",flowID:f})]:[]}const _=new Set;async function en(f){if(!f.length)return[];const d=(await it({segmentIDs:f})).filter(({userFlow:g})=>!(g!=null&&g.flowID)||!_.has(g.flowID));return d.forEach(({userFlow:g})=>{g!=null&&g.flowID&&_.add(g.flowID),g&&y.debug(`Matched campaign ${g.segmentID} (${g.segmentTitle}), serving flow ${g.flowID} (${g.flowTitle})`),new we(g==null?void 0:g.flowID).handleNewSession()}),d}async function tn(){try{const f=await fetch("https://api.ipify.org");return f.status!==200?void 0:await f.text()}catch{return}}async function nn(){c||(await qe(ee()+"/public/app.js"+(te()?`?tag=${encodeURIComponent(te())}`:"")),c=!0)}function rn(f){for(const h of f.map(d=>d.userFlow)){const d=h==null?void 0:h.state.steps.at(-1);if((d==null?void 0:d.step)==="popup"&&!(d!=null&&d.floatingButton))return h==null?void 0:h.flowID}}function Te(){try{const f=w("onAliaReady"),h=d=>{typeof d=="function"&&d()};Array.isArray(f)?f.forEach(h):h(f),M("onAliaReady",void 0),setTimeout(Te,1e3)}catch(f){console.error("Error calling executeOnReady",f)}}}return I.BACKEND_URL=ee,I.SHOP=Y,I.shopifyExtensionInfo=U,Object.defineProperty(I,Symbol.toStringTag,{value:"Module"}),I}({});
